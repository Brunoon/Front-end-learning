<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="UTF-8">
  <title>前端技术</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/Front-end-learning/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/Front-end-learning/css/cayman.css">
  <link rel="stylesheet" href="/Front-end-learning/css/font-awesome.min.css">
  <link rel="stylesheet" href="/Front-end-learning/css/highlight.css">
</head>

  <body>
    <section class="page-header">
    <h1 class="project-name"><a href="/Front-end-learning/README">前端技术</a></h1>
    <h2 class="project-tagline">逸飞的前端打怪日常，主要是javascript</h2>
    <a href="https://github.com/panyifei/Front-end-learning" class="btn">View on GitHub</a>
    <a href="https://github.com/panyifei/Front-end-learning/archive/master.zip" class="btn">Download .zip</a>
</section>

    <section class="main-content">
      <h1>Reuqirejs学习以及实现</h1>

<p>Requirejs是AMD规范的比较好的实践，在看Requirejs之前先看下AMD的规范</p>

<h2>AMD规范</h2>

<p>看的是github上的<a href="https://github.com/amdjs/amdjs-api/wiki/AMD-(%E4%B8%AD%E6%96%87%E7%89%88)">中文翻译的规范</a>。</p>

<p>就是很简单的一个define方法</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="nx">define</span><span class="p">(</span><span class="nx">id</span><span class="o">?</span><span class="p">,</span> <span class="nx">dependencies</span><span class="o">?</span><span class="p">,</span> <span class="nx">factory</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>id为这个定义的模块的名字，如果不提供，默认为指定的脚本的名字，如果提供了，必须是唯一的</li>
<li>二参为依赖，就是模块需要先执行的模块。如果不提供或者提供默认的，就默认是[&quot;require&quot;, &quot;exports&quot;, &quot;module&quot;]，就会扫描工厂方法的require来获得依赖。就是CommonJS的写法了(这个不就是CMD吗？)</li>
<li>三参为函数，在所有的依赖被加载后会自动执行</li>
</ul>

<p>任何全局函数必须有一个amd属性来标识遵循AMD编程接口。</p>

<h2>Requirejs</h2>

<p>这个加载器主要解决的问题：</p>

<ul>
<li>大量JS引入页面的时候会导致页面假死，用了之后就变成异步的了</li>
<li>还有处理各模块之间的依赖，因为不用的话可能JS的引入顺序需要自己控制好</li>
</ul>

<h3>Requirejs使用</h3>

<p>就是引一下requirejs，然后data-main指明入口文件。就像这样：</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;require.js&quot;</span> <span class="na">data-main=</span><span class="s">&quot;main.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div>
<p>然后我们在入口文件里面就可以申明依赖以及函数了。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//main.js</span>
<span class="c1">//引了一个模块sec</span>
<span class="nx">requirejs</span><span class="p">([</span><span class="s2">&quot;sec&quot;</span><span class="p">],</span><span class="kd">function</span><span class="p">(</span><span class="nx">sec</span><span class="p">){</span>
   <span class="nx">sec</span><span class="p">.</span><span class="nx">action</span><span class="p">()</span>
<span class="p">});</span>
<span class="c1">//sec.js</span>
<span class="c1">//这里按照commonjs的形式让requirejs自己去搜一遍，再引入third.js</span>
<span class="nx">define</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">third</span> <span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;third&#39;</span><span class="p">);</span>
    <span class="nx">third</span><span class="p">();</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">22</span><span class="p">)};</span>
<span class="p">});</span>
<span class="c1">//third.js</span>
<span class="nx">define</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">11</span><span class="p">)};</span>
<span class="p">});</span>
</code></pre></div>
<p>入口文件里写requirejs或者define其实都行的。只是requirejs显示是在入口文件。这一这里的sec.js等等都是异步加载的，不会导致页面死在那里。</p>

<h3>文件的路径问题</h3>

<p>我们可以在主入口js中使用requirejs.config来进行配置。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
   <span class="nx">baseUrl</span><span class="o">:</span> <span class="s2">&quot;js/lib&quot;</span><span class="p">,</span>
<span class="err">　</span> <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
<span class="err">　　</span>  <span class="s2">&quot;sec&quot;</span><span class="o">:</span> <span class="s2">&quot;sec.min&quot;</span>
<span class="err">　</span> <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<p>我们可以配置基本的url，可以针对特别的模块单独定义路径，这里的路径还可以是网络请求的位置。</p>

<h3>加载非amd规范的的模块</h3>

<p>我们引入的模块都必须是define申明好的，如果不是的话，得在require里面申明一下。exports为对外输出的变量</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">   <span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
<span class="err">　　　　</span><span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
<span class="err">　　　　　　</span><span class="s1">&#39;underscore&#39;</span><span class="o">:</span><span class="p">{</span>
<span class="err">　　　　　　　　</span><span class="nx">exports</span><span class="o">:</span> <span class="s1">&#39;_&#39;</span>
<span class="err">　　　　　　</span><span class="p">},</span>
<span class="err">　　　　　　</span><span class="s1">&#39;backbone&#39;</span><span class="o">:</span> <span class="p">{</span>
<span class="err">　　　　　　　　</span><span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;jquery&#39;</span><span class="p">],</span>
<span class="err">　　　　　　　　</span><span class="nx">exports</span><span class="o">:</span> <span class="s1">&#39;Backbone&#39;</span>
<span class="err">　　　　　　</span><span class="p">}</span>
<span class="err">　　　　</span><span class="p">}</span>
<span class="err">　　</span><span class="p">});</span>
</code></pre></div>
<p>tudo:这个的写法得去看一看</p>

<h3>require.js的插件</h3>

<p>提供了domready这种类似的插件</p>

<p>tudo:这些个插件也可以看下怎么写的</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">require</span><span class="p">([</span><span class="s1">&#39;domready!&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">){</span>
<span class="err">　　　　</span><span class="c1">// called once the DOM is ready</span>
<span class="p">});</span>
</code></pre></div>
<h3>写一个require</h3>

<p>在阅读源码之前，先试着实现一把。<a href="https://github.com/panyifei/Front-end-learning/tree/master/Demo">链接</a></p>

<p>先实现data-main的主入口，很简单就是分析整个页面，得到data-main，然后新建了一个script，来异步加载js。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">sLength</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">mainJs</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">sLength</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;data-main&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
        <span class="nx">mainJs</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">mainScript</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
<span class="nx">mainScript</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">mainJs</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">mainScript</span><span class="p">);</span>
</code></pre></div>
<p>然后就是声明define方法，我最开始的时候使用的是onload来通知，这样子可以解决一层的依赖。就是如果main依赖了a和b，是可以的。但是如果b依赖了c，这种方法就失败了。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//allModule用来保存所有加载的模块</span>
<span class="kd">var</span> <span class="nx">allModule</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">//主要的define方法</span>
<span class="kd">var</span> <span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">,</span><span class="nx">cb</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">array</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">tempScript</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
            <span class="nx">tempScript</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.js&#39;</span><span class="p">;</span>
            <span class="c1">//目前用的onload来监听加载完毕，但是如果有依赖的话，就不行了</span>
            <span class="nx">tempScript</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                <span class="nx">finish</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">tempScript</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="kd">function</span> <span class="nx">finish</span><span class="p">(){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">length</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span><span class="p">[];</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">x</span><span class="o">&lt;</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">x</span><span class="o">++</span><span class="p">){</span>
                    <span class="nx">modules</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">array</span><span class="p">[</span><span class="nx">x</span><span class="p">]];</span>
                <span class="p">}</span>
                <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span> <span class="p">,</span><span class="nx">modules</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>于是我不用onload来通知，选择在不依赖其他的模块调用完成时来进行通知，并且引用过他的模块尝试执行callback，如果这个模块所需要的都加载完了就可以执行。一层层的向上通知。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//allModule用来保存所有加载的模块</span>
<span class="kd">var</span> <span class="nx">allModule</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">//主要的define方法</span>
<span class="kd">function</span> <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">dependence</span><span class="p">,</span><span class="nx">father</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]){</span>
        <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">=</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">newModule</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="nx">newModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span><span class="c1">//模块的结果</span>
        <span class="nx">newModule</span><span class="p">.</span><span class="nx">dependence</span> <span class="o">=</span> <span class="nx">dependence</span><span class="p">;</span><span class="c1">//依赖的模块</span>
        <span class="nx">newModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//已经依赖的模块</span>
        <span class="nx">newModule</span><span class="p">.</span><span class="nx">finishLoad</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span><span class="c1">//完成load之后触发的方法</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">father</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">newModule</span><span class="p">.</span><span class="nx">referrer</span><span class="p">){</span>
                <span class="nx">newModule</span><span class="p">.</span><span class="nx">referrer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">father</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">newModule</span><span class="p">.</span><span class="nx">referrer</span> <span class="o">=</span> <span class="p">[];</span><span class="c1">//被引用到的模块</span>
                <span class="nx">newModule</span><span class="p">.</span><span class="nx">referrer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">father</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newModule</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">father</span><span class="p">){</span>
            <span class="nx">newModule</span><span class="p">.</span><span class="nx">referrer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">father</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">dependence</span><span class="p">){</span>
            <span class="nx">newModule</span><span class="p">.</span><span class="nx">dependence</span> <span class="o">=</span> <span class="nx">dependence</span><span class="p">;</span>
            <span class="nx">newModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">,</span><span class="nx">cb</span><span class="p">){</span>
    <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">array</span><span class="p">){</span>
        <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">],[],</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">thisModule</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">array</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">tempScript</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
            <span class="nx">tempScript</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.js&#39;</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">tempScript</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">finishLoad</span> <span class="o">=</span> <span class="nx">_finish</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">();</span>
        <span class="nx">_refererFinish</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">_finish</span><span class="p">(){</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span> <span class="o">==</span> <span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependence</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span><span class="p">[];</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">){</span>
                <span class="nx">modules</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">array</span><span class="p">[</span><span class="nx">x</span><span class="p">]].</span><span class="nx">func</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">thisModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span> <span class="p">,</span><span class="nx">modules</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">_refererFinish</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">_refererFinish</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">thisModule</span><span class="p">.</span><span class="nx">referrer</span><span class="p">){</span>
            <span class="nx">thisModule</span><span class="p">.</span><span class="nx">referrer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">array</span><span class="p">){</span>
                <span class="nx">allModule</span><span class="p">[</span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">]].</span><span class="nx">finishLoad</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>这样子实现了一个精简版的API，准备再看下requirejs是如何做的。</p>

<h2>优化</h2>

<p>在勐喆的指导下进行了一次简单的逻辑优化，因为在现在的实现中，每个模块都既存了依赖的列表，以及被依赖到的列表。可以通过事件监听的形式进行一次解耦。也就是模块不再需要知道谁依赖了他，通过注册事件的形式来通知。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//allModule用来保存所有加载的模块</span>
<span class="kd">var</span> <span class="nx">allModule</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">function</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">dependence</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dependence</span> <span class="o">=</span> <span class="nx">dependence</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dependenceLoadNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">}</span>
<span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="o">=</span><span class="p">{</span>
    <span class="nx">on</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">handler</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">name</span><span class="p">]){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">emit</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">name</span><span class="p">]){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
                <span class="nx">value</span><span class="p">();</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">dependence</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">i</span>  <span class="o">=</span> <span class="nx">allModule</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]){</span>
        <span class="nx">allModule</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">=</span> <span class="k">new</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">dependence</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">dependence</span><span class="p">){</span>
            <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">dependence</span> <span class="o">=</span> <span class="nx">dependence</span><span class="p">;</span>
            <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">dependenceLoadNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">dependence</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">value</span><span class="p">,[]);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="c1">//cb为加载完了执行的方法</span>
<span class="kd">var</span> <span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">,</span><span class="nx">cb</span><span class="p">){</span>
    <span class="c1">//注册相关的模块</span>
    <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">thisModule</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
            <span class="nx">thisModule</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span>
                <span class="nx">_finish</span><span class="p">();</span>
                <span class="nx">_notifyModule</span><span class="p">();</span>
            <span class="p">});</span>
            <span class="kd">var</span> <span class="nx">tempScript</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
            <span class="nx">tempScript</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">value</span><span class="o">+</span><span class="s1">&#39;.js&#39;</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">tempScript</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">();</span>
        <span class="nx">_notifyModule</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">_finish</span><span class="p">(){</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span> <span class="o">==</span> <span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependence</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span><span class="p">[];</span>
            <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">){</span>
                <span class="nx">modules</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">value</span><span class="p">].</span><span class="nx">func</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="nx">thisModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span> <span class="p">,</span><span class="nx">modules</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//通知全局的模块加载完毕</span>
    <span class="kd">function</span> <span class="nx">_notifyModule</span><span class="p">(){</span>
        <span class="nx">allModule</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">array</span><span class="p">){</span>
            <span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>这样子的话，define模块的时候就会注册依赖模块的监听器。然后在依赖的模块执行完了时候就会进行全局的触发<em>notifyModule，通知每一个模块这个模块加载OK。于是注册过这个事件的模块就会触发</em>finish方法。这样子最大的好处是进行了一次解耦，代价是会进行全局的广播的形式来通知。其实我们如果用promise来做的话，可以更好的管理状态，但是为了兼容性没有去尝试。</p>

<h2>再次优化</h2>

<p>上面全局通知的代价有些高，看完源码之后才发现，其实事件可以绑定在dependence的模块上面，这样就不用全局通知了。而且这次的修改支持多个文件同时引用一个模块了。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">dependence</span><span class="p">,</span><span class="nx">defined</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">i</span>  <span class="o">=</span> <span class="nx">allModule</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]){</span>
        <span class="nx">allModule</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">=</span> <span class="k">new</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">dependence</span><span class="p">);</span>
        <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">defined</span> <span class="o">=</span> <span class="nx">defined</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">dependence</span><span class="p">){</span>
            <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">dependence</span> <span class="o">=</span> <span class="nx">dependence</span><span class="p">;</span>
            <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">dependenceLoadNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">dependence</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">value</span><span class="p">,[],</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="c1">//cb为加载完了执行的方法</span>
<span class="kd">var</span> <span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">,</span><span class="nx">cb</span><span class="p">){</span>
    <span class="c1">//注册相关的模块</span>
    <span class="nx">_registerModule</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">array</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">thisModule</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
            <span class="nx">allModule</span><span class="p">[</span><span class="nx">value</span><span class="p">].</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span>
                <span class="nx">_finish</span><span class="p">();</span>
            <span class="p">})</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">allModule</span><span class="p">[</span><span class="nx">value</span><span class="p">].</span><span class="nx">defined</span><span class="p">)){</span>
                <span class="kd">var</span> <span class="nx">tempScript</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
                <span class="nx">tempScript</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">value</span><span class="o">+</span><span class="s1">&#39;.js&#39;</span><span class="p">;</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">tempScript</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">();</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">_finish</span><span class="p">(){</span>
        <span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependenceLoadNum</span> <span class="o">==</span> <span class="nx">thisModule</span><span class="p">.</span><span class="nx">dependence</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span><span class="p">[];</span>
            <span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">){</span>
                <span class="nx">modules</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allModule</span><span class="p">[</span><span class="nx">value</span><span class="p">].</span><span class="nx">func</span><span class="p">;</span>
            <span class="p">})</span>
            <span class="nx">thisModule</span><span class="p">.</span><span class="nx">func</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span> <span class="p">,</span><span class="nx">modules</span><span class="p">);</span>
            <span class="c1">//继续向上层触发</span>
            <span class="nx">thisModule</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>这次的优化改了define方法，去掉了全局的通知。还增加了defined属性来支持多个模块引用同一个模块。</p>

<p>参考：</p>

<p>http://www.ruanyifeng.com/blog/2012/11/require_js.html</p>

      <div id="disqus_thread"></div>
<script>
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = '//panyifei.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="//panyifei.disqus.com/count.js" async></script>

      <!-- <footer class="site-footer">
  <span class="site-footer-owner"><a href="">前端技术</a> is maintained by <a href="https://github.com/panyifei">逸飞</a>.</span>
</footer> -->

<footer>
	<div class="span-inline">
		
			<span>
				<a target="_blank" href="https://github.com/panyifei">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa fa-github fa-stack-1x fa-inverse"></i>
					</span>
				</a>
			</span>
		
		
			<span>
				<a target="_blank" href="https://www.zhihu.com/people/pan-yi-fei-52">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa  fa-stack-1x fa-inverse">知</i>
					</span>
				</a>
			</span>
		
		
			<span>
				<a target="_blank" href="http://www.jianshu.com/users/3b9067fb7edf">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa  fa-stack-1x fa-inverse">简</i>
					</span>
				</a>
			</span>
		
	</div>
	<p class="copyright">
		Copyright &copy; 前端技术 2016
		<br>
		Owned by <a href="https://github.com/panyifei">潘逸飞</a>
	</p>
</footer>

    </section>
  </body>
</html>
