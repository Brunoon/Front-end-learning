<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="UTF-8">
  <title>前端技术</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/Front-end-learning/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/Front-end-learning/css/cayman.css">
  <link rel="stylesheet" href="/Front-end-learning/css/font-awesome.min.css">
  <link rel="stylesheet" href="/Front-end-learning/css/highlight.css">
</head>

  <body>
    <section class="page-header">
    <h1 class="project-name"><a href="/Front-end-learning/README">前端技术</a></h1>
    <h2 class="project-tagline">逸飞的前端打怪日常，主要是javascript</h2>
    <a href="https://github.com/panyifei/Front-end-learning" class="btn">View on GitHub</a>
    <a href="https://github.com/panyifei/Front-end-learning/archive/master.zip" class="btn">Download .zip</a>
</section>

    <section class="main-content">
      <h1>hashchange事件</h1>

<p>这里承接history相关，对于后退键不刷新页面，使用了修改hash来模拟实现的方法。</p>

<p><code>hashchange</code>其实就是一个window的事件，在页面的hash被修改时会被触发。下面直接根据代码讲解吧。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">popPage</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">iScroll</span><span class="p">,</span><span class="nx">options</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">showFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">parentEl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;pop-page&quot;&gt;&lt;div class=&quot;user-control&quot; id=&quot;user-control&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;hashchange&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">==</span> <span class="s2">&quot;#poppage&quot;</span><span class="p">){</span>
            <span class="c1">//前进键打开(ios)，直接清hash</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">showFlag</span><span class="p">){</span>
                <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">showFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="c1">//body设置overflow可能会滚到到头部，先保存</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
            <span class="c1">//安卓需要给body和html都加上才会锁住</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;fix-scroll&#39;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;fix-scroll&#39;</span><span class="p">);</span>
            <span class="c1">//小的兼容问题，不设置的页面有几率不回到顶部</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">parentEl</span><span class="p">);</span>
            <span class="c1">//android2.3 bug，不加setTimeout初始化iSroll失败</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="c1">//class改变得在setTimeout里面</span>
                <span class="c1">//animation   android2.3部分支持，测试无效，最后使用了transction</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">parentEl</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;from-right&#39;</span><span class="p">);</span>
                <span class="c1">//判断iScroll是否传入</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">iScroll</span><span class="o">!=</span><span class="kc">undefined</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{</span><span class="nx">click</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
                    <span class="k">new</span> <span class="nx">iScroll</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;user-control&#39;</span><span class="p">),</span><span class="nx">options</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//还原，清空</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;fix-scroll&#39;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;fix-scroll&#39;</span><span class="p">);</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">().</span><span class="nx">empty</span><span class="p">();</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">parentEl</span><span class="p">.</span><span class="nx">remove</span><span class="p">().</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;from-right&#39;</span><span class="p">);</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>
<ul>
<li><p>阻止了页面默认行为，页面的滚动自己来控制，不会有烦人的兼容</p></li>
<li><p>切换hash触发window的hashchange事件</p></li>
<li><p>body元素固定住，不让他滚动，原页面最小影响</p></li>
<li><p>手机浏览器哪怕body设置了<code>overflow</code>也是可以滚动的，解决方式是给<code>html</code>也加上<code>overflow</code></p></li>
<li><p>使用<code>overflow</code>有个坑，安卓2.3不支持这个属性，所以想做的话，从外部传进一个iscroll</p></li>
<li><p>外部传入iscroll，为了兼容，我传入了元素<code>document.getElementById(&#39;user-control&#39;)</code></p></li>
<li><p>iscroll对于新生成的元素需要写在settimeout里面</p></li>
<li><p>动画选择使用transction，animation在安卓2.3支持不好</p></li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="nx">popPage</span><span class="p">.</span><span class="nx">newPage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">showFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="c1">//这样来触发hashchange方法</span>
        <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;#poppage&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="nx">popPage</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentEl</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s1">&#39;.user-control&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">popPage</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="c1">//这里加了个setTimeout，就可以直接清除了</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">==</span> <span class="s2">&quot;#poppage&quot;</span><span class="p">){</span>
                <span class="nx">history</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;还未添加页面&#39;</span><span class="p">);</span>
            <span class="p">}</span>    
        <span class="p">},</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">popPage</span><span class="p">;</span>
</code></pre></div>
<p>这里是生成的页面，然后还提供了一个close方法，可供外界关闭这个新页面，这里的close用<code>setTimeout</code>包住了，不然会有异步的问题。还提供了一个可以得到内部元素的指针。</p>

<p>还得配合以下的css一起使用</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="nc">.pop-page</span><span class="p">{</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
    <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="k">height</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="k">overflow</span><span class="o">:</span> <span class="k">scroll</span><span class="p">;</span>
    <span class="k">margin</span><span class="o">:</span><span class="m">0px</span> <span class="m">-20px</span> <span class="m">0px</span> <span class="m">20px</span><span class="p">;</span>
    <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="o">.</span><span class="m">9</span><span class="p">;</span>
    <span class="n">transition</span><span class="o">:</span><span class="n">all</span> <span class="m">0.5s</span><span class="p">;</span>
    <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span><span class="n">all</span> <span class="m">0.5s</span><span class="p">;</span> <span class="c">/* Firefox 4 */</span>
    <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span><span class="n">all</span> <span class="m">0.5s</span><span class="p">;</span> <span class="c">/* Safari and Chrome */</span>
    <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span><span class="n">all</span> <span class="m">0.5s</span><span class="p">;</span> <span class="c">/* Opera */</span>
<span class="p">}</span>
<span class="nc">.from-right</span><span class="p">{</span>
    <span class="k">margin</span><span class="o">:</span><span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">0px</span><span class="p">;</span>
    <span class="k">opacity</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.fix-scroll</span><span class="p">{</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
    <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="k">height</span><span class="o">:</span><span class="m">100%</span><span class="p">;</span>
    <span class="k">overflow</span><span class="o">:</span><span class="k">hidden</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.user-control</span><span class="p">{</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
    <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="k">height</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2>总结</h2>

<p>踩了无数的android2.3的坑。包括动画，overflow。</p>

<p>后退时将新页面销毁了，因为这样比较安全。</p>

<p>意味着前进键回不去了，不是做不到支持前进键，而是不安全。</p>

<p>这个模块在勐喆的帮助下修改了很多次，逐渐变得越来越抽象，而且对原页面无痛。支持情况很好。</p>

      <div id="disqus_thread"></div>
<script>
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = '//panyifei.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="//panyifei.disqus.com/count.js" async></script>

      <!-- <footer class="site-footer">
  <span class="site-footer-owner"><a href="">前端技术</a> is maintained by <a href="https://github.com/panyifei">逸飞</a>.</span>
</footer> -->

<footer>
	<div class="span-inline">
		
			<span>
				<a target="_blank" href="https://github.com/panyifei">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa fa-github fa-stack-1x fa-inverse"></i>
					</span>
				</a>
			</span>
		
		
			<span>
				<a target="_blank" href="https://www.zhihu.com/people/pan-yi-fei-52">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa  fa-stack-1x fa-inverse">知</i>
					</span>
				</a>
			</span>
		
		
			<span>
				<a target="_blank" href="http://www.jianshu.com/users/3b9067fb7edf">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa  fa-stack-1x fa-inverse">简</i>
					</span>
				</a>
			</span>
		
	</div>
	<p class="copyright">
		Copyright &copy; 前端技术 2016
		<br>
		Owned by <a href="https://github.com/panyifei">潘逸飞</a>
	</p>
</footer>

    </section>
  </body>
</html>
