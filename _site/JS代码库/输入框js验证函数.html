<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="UTF-8">
  <title>前端技术</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/Front-end-learning/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/Front-end-learning/css/cayman.css">
  <link rel="stylesheet" href="/Front-end-learning/css/font-awesome.min.css">
</head>

  <body>
    <section class="page-header">
  <h1 class="project-name">前端技术</h1>
  <h2 class="project-tagline">一个前端工程狮的打怪日常，主要是javascript</h2>
  <a href="https://github.com/panyifei/Front-end-learning" class="btn">View on GitHub</a>
  <a href="https://github.com/panyifei/Front-end-learning/archive/master.zip" class="btn">Download .zip</a>
  <!-- <a href="#" class="btn">Download .tar.gz</a> -->
</section>

    <section class="main-content">
      <h1 id="js">输入框js验证函数</h1>

<h2 id="section">功能</h2>

<p>手机浏览器下<code class="highlighter-rouge">保证</code>7位数值的输入，包括小数点，这个的处理安全的过分了，因为边界情况太多了，无论是手机型号，还有输入法</p>

<h2 id="section-1">代码解释</h2>

<div class="language-html highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"number"</span> <span class="na">class=</span><span class="s">"amount J-total-amount"</span> <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="na">maxlength=</span><span class="s">"7"</span><span class="nt">&gt;</span>
</code></pre>
</div>

<p>配合js代码使用，就万无一失了，有详细的代码注释，主要是用了一些正则的检验,这里还是有坑的…</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>        <span class="c1">//单单监听input不能达到效果，边界的不一定可以搞定</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">inputSelectionSupported</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'input'</span><span class="p">).</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'selectionStart'</span><span class="p">);</span>
        <span class="c1">//fix firefox 下面的小bug</span>
        <span class="k">if</span><span class="p">(</span><span class="sr">/Firefox</span><span class="se">\/(\S</span><span class="sr">+</span><span class="se">)</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)){</span>
            <span class="nx">els</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">array</span><span class="p">){</span>
                <span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'text'</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">inputs</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'input'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="c1">//input是在输入框改变更新了数值之后才出发</span>
            <span class="nx">sanitizeInput</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'keypress'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//keypress是在输入框改变之前就触发了</span>
            <span class="c1">//之所以监听keypress是因为keyup，keydown有些情况下获得的key不标准</span>
            <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">code</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">39</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  <span class="c1">// backspace, left, right</span>
            <span class="c1">//这个东西firefox下为true</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">inputSelectionSupported</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// strict test</span>
                <span class="kd">var</span> <span class="nx">endArr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
                <span class="nx">endArr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectionStart</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectionEnd</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectionStart</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">endValue</span> <span class="o">=</span> <span class="nx">endArr</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">endNumber</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">endValue</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^</span><span class="se">\d</span><span class="sr">*</span><span class="se">\.?\d{0,2}</span><span class="sr">$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">endValue</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">endNumber</span><span class="p">)</span> <span class="o">||</span> <span class="nx">endNumber</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// fallback to week test</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">'.'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^</span><span class="se">\d</span><span class="sr">$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">sanitizeInput</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sanitized</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//iosbug，直接点击文字的话会输入成功，拿不到input.value</span>
                <span class="c1">//小米bug，上面的“-”也能直接输入成功，拿不到input.value</span>
                <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">modified</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="c1">// 长度限制</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sanitized</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
                <span class="nx">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 非法字符处理</span>
            <span class="c1">// 将非数字，非.的用空字符串替换</span>
            <span class="kd">var</span> <span class="nx">mreg</span> <span class="o">=</span> <span class="sr">/</span><span class="se">[^\d\.]</span><span class="sr">/g</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">mreg</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">sanitized</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">mreg</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
                <span class="nx">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 多小数点处理</span>
            <span class="c1">// 这里的正则就是分组捕获了</span>
            <span class="kd">var</span> <span class="nx">preg</span> <span class="o">=</span> <span class="sr">/</span><span class="se">(\d</span><span class="sr">*</span><span class="se">\.\d</span><span class="sr">*</span><span class="se">)\.(\d</span><span class="sr">*</span><span class="se">)</span><span class="sr">/g</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">preg</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">sanitized</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">preg</span><span class="p">,</span> <span class="s1">'$1$2'</span><span class="p">);</span>
                <span class="nx">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 去头部0</span>
            <span class="kd">var</span> <span class="nx">zreg</span> <span class="o">=</span> <span class="sr">/^0+</span><span class="se">(\d</span><span class="sr">+</span><span class="se">)</span><span class="sr">/</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">zreg</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">sanitized</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">zreg</span><span class="p">,</span> <span class="s1">'$1'</span><span class="p">);</span>
                <span class="nx">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 小数点精度处理</span>
            <span class="c1">// 这里的正则就是判断是否小数点有三位</span>
            <span class="kd">var</span> <span class="nx">floatEnd</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/</span><span class="se">\d</span><span class="sr">*</span><span class="se">\.(\d{3,})</span><span class="sr">/</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">floatEnd</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">floatEnd</span> <span class="o">=</span> <span class="nx">floatEnd</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="nx">floatEnd</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                <span class="nx">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">modified</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
</code></pre>
</div>

      <div id="disqus_thread"></div>
<script>
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = '//panyifei.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="//panyifei.disqus.com/count.js" async></script>

      <!-- <footer class="site-footer">
  <span class="site-footer-owner"><a href="">前端技术</a> is maintained by <a href="https://github.com/panyifei">逸飞</a>.</span>
</footer> -->

<footer>
	<div class="span-inline">
		
			<span>
				<a target="_blank" href="https://github.com/panyifei">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa fa-github fa-stack-1x fa-inverse"></i>
					</span>
				</a>
			</span>
		
		
			<span>
				<a target="_blank" href="https://www.zhihu.com/people/pan-yi-fei-41">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa  fa-stack-1x fa-inverse">知</i>
					</span>
				</a>
			</span>
		
		
			<span>
				<a target="_blank" href="http://www.jianshu.com/users/3b9067fb7edf">
					<span class="fa-stack fa-lg">
						<i class="fa fa-circle fa-stack-2x"></i>
						<i class="fa  fa-stack-1x fa-inverse">简</i>
					</span>
				</a>
			</span>
		
	</div>
	<p class="copyright">
		Copyright &copy; 前端技术 2016
		<br>
		Theme by <a href="https://github.com/pietromenna">Pietromenna</a>
	</p>
</footer>

    </section>
  </body>
</html>
